import streamlit as st
import pandas as pd

# ---------------------------------------------------------
# 1. ì„¤ë¬¸ ê¸°ë³¸ ì„¤ì • ë° ë°ì´í„° ì •ì˜
# ---------------------------------------------------------
st.set_page_config(page_title="êµìœ¡í›ˆë ¨ ê¸°ê°„ ì„¤ë¬¸ì¡°ì‚¬", layout="wide")

st.title("ğŸª– êµìœ¡í›ˆë ¨ ê¸°ê°„ ì²´ê³„ ê°œì„ ì„ ìœ„í•œ ì „ë¬¸ê°€ ì„¤ë¬¸ (AHP)")
st.markdown("""
### ì„¤ë¬¸ ì•ˆë‚´
ê° **ì œ3ê³„ì¸µ í•˜ìœ„ í›ˆë ¨ í•­ëª©**ì— ëŒ€í•˜ì—¬, **180ì¼í˜•**ê³¼ **70ì¼í˜•** ì¤‘ ì–´ëŠ ìª½ì´ ë” íš¨ê³¼ì ì´ë¼ê³  ìƒê°í•˜ì‹œëŠ”ì§€ **5ì  ì²™ë„**ë¡œ í‰ê°€í•´ ì£¼ì‹­ì‹œì˜¤.
""")

st.divider()

# ê³„ì¸µ êµ¬ì¡° ì •ì˜ (ëŒ€ë¶„ë¥˜ - í•˜ìœ„í•­ëª©)
hierarchy = {
    "ì „íˆ¬ê¸°ìˆ ": ["ì „ì‹œë¬¼ì êµ°ìˆ˜ì§€ì›", "ê°œì¸í™”ê¸° ì‚¬ê²©", "í¸ì œì¥ë¹„ ìš´ìš©"],
    "ì‘ê³„ì‹œí–‰": ["ì§€íœ˜í†µì œê¸°êµ¬ í›ˆë ¨", "ì‘ê³„ì§€ì—­ ì§€í˜•ì •ì°°", "ì¦Â·ì°½ì„¤ ì ˆì°¨ ìˆ™ë‹¬"],
    "êµê´€ëŠ¥ë ¥": ["ì „ì‹œêµê´€ ìê²©ì¸ì¦í‰ê°€", "ê³µìš©í™”ê¸° ì§‘ì²´êµìœ¡", "ë³‘ì§„ê¸‰ê°œì¸ê¸°ë³¸í›ˆë ¨í‰ê°€"]
}

# 5ì  ì²™ë„ ì˜µì…˜ ë° ì ìˆ˜ ë§¤í•‘ (ìŒëŒ€ë¹„êµ ê°’ìœ¼ë¡œ ë³€í™˜)
# AHP 9ì  ì²™ë„ë¥¼ 5ì  ì²™ë„ë¡œ ê°„ì†Œí™”í•˜ì—¬ ë§¤í•‘ (ì‚¬ìš©ì í¸ì˜ì„±)
# ë§¤ìš° ìš°ì„¸(4:1) / ìš°ì„¸(3:1) / ë™ì¼(1:1) ë“±ìœ¼ë¡œ ê°€ì •
scale_options = [
    "180ì¼í˜• ë§¤ìš° ìš°ì„¸", 
    "180ì¼í˜• ìš°ì„¸", 
    "ë¹„ìŠ·í•¨ (ë™ì¼)", 
    "70ì¼í˜• ìš°ì„¸", 
    "70ì¼í˜• ë§¤ìš° ìš°ì„¸"
]

# ì„ íƒì§€ì— ë”°ë¥¸ ê°€ì¤‘ì¹˜ ë¡œì§ (180ì¼í˜• ê¸°ì¤€ ê°€ì¤‘ì¹˜)
# ì˜ˆ: 180ì¼í˜• ë§¤ìš° ìš°ì„¸ -> 180ì¼í˜•ì— 0.8(4/5) ë¶€ì—¬ ë“±
weight_mapping = {
    "180ì¼í˜• ë§¤ìš° ìš°ì„¸": 0.833, # ì•½ 5:1 ë¹„ìœ¨
    "180ì¼í˜• ìš°ì„¸": 0.750,      # 3:1 ë¹„ìœ¨
    "ë¹„ìŠ·í•¨ (ë™ì¼)": 0.500,      # 1:1 ë¹„ìœ¨
    "70ì¼í˜• ìš°ì„¸": 0.250,       # 1:3 ë¹„ìœ¨
    "70ì¼í˜• ë§¤ìš° ìš°ì„¸": 0.167    # 1:5 ë¹„ìœ¨
}

# ---------------------------------------------------------
# 2. ì„¤ë¬¸ UI ìƒì„± (ì œ3ê³„ì¸µ í•­ëª©ë³„ í‰ê°€)
# ---------------------------------------------------------
responses = []

# ëŒ€ë¶„ë¥˜ë³„ ë°˜ë³µ
for main_cat, sub_items in hierarchy.items():
    st.subheader(f"ğŸ“Œ {main_cat}")
    
    for item in sub_items:
        col1, col2 = st.columns([1, 2])
        
        with col1:
            st.write(f"**{item}**")
            st.caption(f"{item} ìˆ™ë‹¬ì— ë” ìœ ë¦¬í•œ ê¸°ê°„ì€?")
        
        with col2:
            # 5ì  ì²™ë„ ë¼ë””ì˜¤ ë²„íŠ¼ (ê°€ë¡œ ë°°ì—´) ë˜ëŠ” ìŠ¬ë¼ì´ë”
            choice = st.select_slider(
                label=f"{item}_scale",
                options=scale_options,
                value="ë¹„ìŠ·í•¨ (ë™ì¼)", # ê¸°ë³¸ê°’
                label_visibility="collapsed"
            )
            
            # ë°ì´í„° ì €ì¥ ë¡œì§
            w_180 = weight_mapping[choice]
            w_70 = 1.0 - w_180
            
            # ìš°ì„¸ ëŒ€ì•ˆ í…ìŠ¤íŠ¸ ê²°ì •
            if w_180 > w_70:
                winner = "180ì¼í˜•"
            elif w_70 > w_180:
                winner = "70ì¼í˜•"
            else:
                winner = "ë™ì¼"

            responses.append({
                "ëŒ€ë¶„ë¥˜": main_cat,
                "í•˜ìœ„ í›ˆë ¨ í•­ëª©": item,
                "ì„ íƒ": choice,
                "180ì¼í˜• ê°€ì¤‘ì¹˜": w_180,
                "70ì¼í˜• ê°€ì¤‘ì¹˜": w_70,
                "ìš°ì„¸ ëŒ€ì•ˆ": winner
            })
    
    st.divider()

# ---------------------------------------------------------
# 3. ê²°ê³¼ ì§‘ê³„ ë° í‘œì¶œ
# ---------------------------------------------------------
if st.button("ì„¤ë¬¸ ê²°ê³¼ ì œì¶œ ë° ë¶„ì„ í™•ì¸"):
    st.success("ì„¤ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì•„ë˜ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
    
    # ë°ì´í„°í”„ë ˆì„ ë³€í™˜
    df_result = pd.DataFrame(responses)
    
    # ì†Œìˆ˜ì  í¬ë§·íŒ…
    df_display = df_result.copy()
    df_display["180ì¼í˜• ê°€ì¤‘ì¹˜"] = df_display["180ì¼í˜• ê°€ì¤‘ì¹˜"].map('{:.3f}'.format)
    df_display["70ì¼í˜• ê°€ì¤‘ì¹˜"] = df_display["70ì¼í˜• ê°€ì¤‘ì¹˜"].map('{:.3f}'.format)
    
    # 1. ê²°ê³¼ í…Œì´ë¸” ì¶œë ¥
    st.subheader("ğŸ“Š í•­ëª©ë³„ ê°€ì¤‘ì¹˜ ë¶„ì„ ê²°ê³¼")
    st.dataframe(
        df_display[["ëŒ€ë¶„ë¥˜", "í•˜ìœ„ í›ˆë ¨ í•­ëª©", "180ì¼í˜• ê°€ì¤‘ì¹˜", "70ì¼í˜• ê°€ì¤‘ì¹˜", "ìš°ì„¸ ëŒ€ì•ˆ"]],
        use_container_width=True,
        hide_index=True
    )
    
    # 2. ìš”ì•½ ì°¨íŠ¸ (ë°” ì°¨íŠ¸)
    st.subheader("ğŸ“ˆ ëŒ€ì•ˆë³„ ì„ í˜¸ë„ ì‹œê°í™”")
    chart_data = df_result[["í•˜ìœ„ í›ˆë ¨ í•­ëª©", "180ì¼í˜• ê°€ì¤‘ì¹˜", "70ì¼í˜• ê°€ì¤‘ì¹˜"]].set_index("í•˜ìœ„ í›ˆë ¨ í•­ëª©")
    st.bar_chart(chart_data)

    # (ì„ íƒì‚¬í•­) CSV ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
    csv = df_display.to_csv(index=False).encode('utf-8-sig')
    st.download_button(
        label="ê²°ê³¼ ì—‘ì…€(CSV)ë¡œ ë‹¤ìš´ë¡œë“œ",
        data=csv,
        file_name='survey_result_AHP.csv',
        mime='text/csv',
    )
